const fs = require("fs");
const admin = require("firebase-admin");

// Load Firebase service account from Github secret
const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);

admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
});

// Read old + new playlists
const oldData = JSON.parse(fs.readFileSync("old_playlists.json", "utf8"));
const newData = JSON.parse(fs.readFileSync("playlists.json", "utf8"));

// Convert to string to detect any change
const oldString = JSON.stringify(oldData);
const newString = JSON.stringify(newData);

if (oldString === newString) {
    console.log("No changes detected. No notification sent.");
    process.exit(0);
}

// send notification
admin.messaging().send({
    topic: "new_music",
    notification: {
        title: "Playlist Updated ðŸŽ¶",
        body: "New music added!",
    }
})
.then(() => {
    console.log("Notification sent!");
})
.catch(err => {
    console.error("FCM ERROR:", err);
});

// save new version
fs.writeFileSync("old_playlists.json", JSON.stringify(newData, null, 2));
